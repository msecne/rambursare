<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <title>Plata anticipata credite ipotecare</title>
    <style type="text/css">
        body {
            font-family: Arial, sans-serif;
            background-color: #2e2e2e;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
        }

        .table-container {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        th,
        td {
            border: 1px solid #555;
            padding: 10px;
            text-align: right;
            word-wrap: break-word;
        }

        th {
            font-family: 'Roboto', Arial;
            background-color: #3a3a3a;
            color: #4CAF50;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:nth-child(even) {
            background-color: #3f3f3f;
        }

        tr:hover {
            background-color: #4a4a4a;
        }

        form {
            margin: 20px;
            background-color: #3a3a3a;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
        }

        label {
            margin: 5px 0;
            font-size: 14px;
            display: block;
        }

        input {
            border: 1px solid #777;
            border-radius: 4px;
            padding: 8px;
            background-color: #4a4a4a;
            color: #e0e0e0;
            font-size: 14px;
            width: calc(100% - 16px);
            margin-bottom: 10px;
        }

        .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background-color: #45a049;
        }

        @media (max-width: 600px) {
            form {
                margin: 10px;
                padding: 10px;
            }

            label,
            input,
            button {
                font-size: 12px;
            }
        }

        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #4CAF50;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip-container:hover .tooltip-text,
        .tooltip-container:focus-within .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        select {
            border: 1px solid #777;
            border-radius: 4px;
            padding: 8px;
            background-color: #4a4a4a;
            color: #e0e0e0;
            font-size: 14px;
            width: calc(100% - 16px);
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <script async data-id="101443145" src="//static.getclicky.com/js"></script>
    <div style="text-align: center;">
        <h3>Calculator credite ipotecare</h3>
    </div>
    <form id="loanForm">
        <div style="display: flex;">
            <label for="new2"><strong>NOU:</strong> <a href="https://msecne.github.io/indatorare/" target="_blank"
                style="color: #228B22; text-decoration: none;">Calculator grad indatorare</a></label>
          </div>
        <div style="display: flex;">
            <label for="new1"><strong>NOU:</strong> <a href="https://msecne.github.io/dobanzi/" target="_blank"
                style="color: #228B22; text-decoration: none;">Comparator dobanzi economii</a></label>
          </div>
        <label for="credit">Valoarea creditului:</label>
        <input type="number" id="credit" name="credit" value="250000" required>
        <label for="months">Durată credit (luni):</label>
        <input type="number" id="months" name="months" value="360" required>
        <label for="fixedRate">Dobândă fixă (%):</label>
        <input type="number" id="fixedRate" name="fixedRate" value="5.79" step="0.01" required>
        <label for="fixedRatePeriod">Perioadă dobândă fixă (luni):</label>
        <input type="number" id="fixedRatePeriod" name="fixedRatePeriod" value="60" required>
        <label for="ircc">IRCC (%):</label>
        <input type="number" id="ircc" name="ircc" value="5.66" step="0.01" required>
        <label for="margin">Marja băncii (%):</label>
        <input type="number" id="margin" name="margin" value="2.29" step="0.01" required>
        <label for="insurancePercent">Asigurare / comision (%):
            <span class="tooltip-container">
                <span class="infopoint"
                    style="font-size: 16px; padding: 0; border: none; background: none; color: #4CAF50; cursor: default; margin-left: 5px; display: inline;">info</span>
                <span class="tooltip-text">Comision reprezentând asigurarea de viață sau comisionul de administrare
                    lunară a creditului ca procent din soldul lunar.</span>
            </span>
        </label>
        <input type="number" id="insurancePercent" name="insurancePercent" value="0" step="0.01" required>
        <label for="monthlyAdvancePayment">
            Valoare plată anticipată lunară:
            <span class="tooltip-container">
                <span class="infopoint"
                    style="font-size: 16px; padding: 0; border: none; background: none; color: #4CAF50; cursor: default; margin-left: 5px; display: inline;">info</span>
                <span class="tooltip-text">Suma plătită anticipat lunar poate crește sau scădea în funcție de rata
                    totală, astfel încât să se mențină pe cât posibil o rată fixă pe toată perioada creditului.</span>
            </span>
        </label>
        <input type="number" id="monthlyAdvancePayment" name="monthlyAdvancePayment" value="500" required>
        <label for="calculationType">Tip calcul:</label>
        <select id="calculationType" name="calculationType" required>
            <option value="scaderea_perioadei">Scăderea perioadei</option>
            <option value="scaderea_ratei">Scăderea ratei</option>
            <option value="rate_descrescatoare">Rate descrescătoare</option>
        </select>
        <div class="button-container">
            <button type="button" id="calculateButton">Calculează</button>
            <button type="button" id="exportButton">Exportă în CSV</button>
        </div>
    </form>
    <table id="summaryTable">
    </table>
    <br>
    <br>
    <table id="loanTable">
    </table>

    <script>

        function calculatePMT(rate, nper, pv) {
            const r = rate / 12 / 100;
            return (pv * r * Math.pow(1 + r, nper)) / (Math.pow(1 + r, nper) - 1);
        }


        function calculateRemainingTerm(
            principal,
            annualInterestRate,
            monthlyPayment,
            extraPayment,
        ) {
            const monthlyInterestRate = annualInterestRate / 12 / 100;
            const newPrincipal = principal - extraPayment;
            const remainingTerm =
                Math.log(
                    monthlyPayment / (monthlyPayment - newPrincipal * monthlyInterestRate),
                ) / Math.log(1 + monthlyInterestRate);
            return Math.ceil(remainingTerm);
        }

        function calculateRemainingBalance(rate, nper, pv, paymentsMade) {
            const monthlyRate = rate / 12 / 100;
            const monthlyPayment = calculatePMT(rate, nper, pv);
            let remainingBalance = pv;

            for (let i = 0; i < paymentsMade; i++) {
                const interest = remainingBalance * monthlyRate;
                const principal = monthlyPayment - interest;
                remainingBalance -= principal;
            }

            return remainingBalance;
        }

        function formatNumber(num) {
            const numberValue = parseFloat(num);
            const [integerPart, decimalPart] = numberValue.toFixed(2).split('.');
            const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

            return decimalPart === '00' ? formattedInteger : `${formattedInteger},${decimalPart}`;
        }

        function calculateTotalPaid(initialRate, newRate, nper, pv, changePeriod, insurance) {
            let totalPaid = 0;
            let remainingBalance = pv;
            let totalInsurancePaid = 0;

            for (let month = 1; month <= nper; month++) {
                const currentRate = month <= changePeriod ? initialRate : newRate;
                const monthlyInterestRate = currentRate / 12 / 100;

                const monthlyPayment = calculatePMT(currentRate, nper - month + 1, remainingBalance);

                totalPaid += monthlyPayment;
                totalInsurancePaid += (remainingBalance * insurance) / 100;

                remainingBalance -= (monthlyPayment - (remainingBalance * monthlyInterestRate));

                if (remainingBalance <= 0) {
                    break;
                }
            }

            return {
                totalPaid: Math.round(totalPaid * 100) / 100,
                totalInsurancePaid: Math.round(totalInsurancePaid * 100) / 100,
            };
        }


        function calculateTotalWithReducingRate(credit, months, initialRate, newRate, changePeriod, insurancePercent) {
            let principal = credit / months;
            let remainingBalance = credit;
            let totalInterest = 0;
            let totalMonthlyRatesPayment = 0;
            let totalInsurancePayment = 0;

            for (let month = 1; month <= months; month++) {
                const rate = month <= changePeriod ? initialRate : newRate;

                let monthlyInterest = (remainingBalance * rate) / 12 / 100;
                let loanRate = monthlyInterest + principal;

                if (remainingBalance - principal < 0) {
                    principal = remainingBalance;
                }

                let totalMonthlyPayment = loanRate;
                const insurance = (remainingBalance * insurancePercent) / 100;

                remainingBalance = Math.max(0, remainingBalance - principal);

                if (remainingBalance >= 0) {
                    totalMonthlyRatesPayment += totalMonthlyPayment;
                    totalInsurancePayment += insurance;
                }

                if (remainingBalance <= 0) {
                    break;
                }
            }

            return {
                totalPaid: Math.round(totalMonthlyRatesPayment * 100) / 100,
                totalInsurancePaid: Math.round(totalInsurancePayment * 100) / 100,
            };
        }

        function calculateLoanWithReducingRate(data) {
            const rows = [];
            const summaryRows = [];
            let principal = data.credit / data.months;
            let remainingBalance = data.credit;
            let totalInterest = 0;
            let totalPrincipal = 0;
            let totalMonthlyRates = 0;
            let totalAdvancePayments = 0;
            let totalMonthlyRatesPayment = 0;
            let totalInsurancePayment = 0;
            let grandTotalMonth = 0;
            let adjustedMonthlyAdvancePayment = data.monthlyAdvancePayment;
            let advancePayment = 0;
            let maxTotalMonthlyPayment = 0;

            for (let month = 1; month <= data.months; month++) {
                const rate =
                    month <= data.fixedRatePeriod ? data.fixedRate : data.ircc + data.margin;



                let monthlyInterest = (remainingBalance * rate) / 12 / 100;
                let loanRate = monthlyInterest + principal;

                if (month === 1) {
                    maxTotalMonthlyPayment = loanRate + data.monthlyAdvancePayment;
                }

                if (data.monthlyAdvancePayment > 0 && month <= data.fixedRatePeriod) {
                    adjustedMonthlyAdvancePayment = maxTotalMonthlyPayment - loanRate;
                }

                if (data.monthlyAdvancePayment > 0 && month > data.fixedRatePeriod) {
                    adjustedMonthlyAdvancePayment = Math.max(
                        0,
                        maxTotalMonthlyPayment - loanRate,
                    );
                }

                if (remainingBalance - principal < 0) {
                    principal = remainingBalance;
                }

                if (remainingBalance - principal - adjustedMonthlyAdvancePayment < 0) {
                    adjustedMonthlyAdvancePayment = Math.max(0, remainingBalance - principal);
                }

                let leftMaturity = data.months - month;
                let totalMonthlyPayment = loanRate + adjustedMonthlyAdvancePayment;
                const insurance = (remainingBalance * data.insurancePercent) / 100;

                remainingBalance = Math.max(
                    0,
                    remainingBalance - principal - adjustedMonthlyAdvancePayment,
                );

                if (remainingBalance >= 0) {
                    totalMonthlyRates += loanRate;
                    totalPrincipal += principal;
                    totalInterest += monthlyInterest;
                    totalAdvancePayments += adjustedMonthlyAdvancePayment;
                    totalMonthlyRatesPayment += totalMonthlyPayment;
                    totalInsurancePayment += insurance;
                    grandTotalMonth += totalMonthlyPayment + insurance;
                }

                rows.push({
                    month,
                    remainingBalance: remainingBalance,
                    monthlyPayment: loanRate,
                    principal: principal,
                    interest: monthlyInterest,
                    rate: rate,
                    margin: month <= data.fixedRatePeriod ? 0 : data.margin,
                    ircc: month <= data.fixedRatePeriod ? 0 : data.ircc,
                    adjustedMonthlyAdvancePayment: adjustedMonthlyAdvancePayment,
                    totalMonthlyPayment: totalMonthlyPayment,
                    insurance: insurance,
                    totalPayment: totalMonthlyPayment + insurance,
                    maturity: leftMaturity
                });

                if (remainingBalance <= 0) {
                    break;
                }
            }

            rows.push({
                month: "TOTALURI",
                remainingBalance: `<strong style="color: #228B22;">--</strong>`,
                monthlyPayment: `<strong style="color: #228B22;">${formatNumber(totalMonthlyRates)}</strong>`,
                principal: `<strong style="color: #228B22;">${formatNumber(totalPrincipal)}</strong>`,
                interest: `<strong style="color: #228B22;">${formatNumber(totalInterest)}</strong>`,
                rate: `<strong style="color: #228B22;">--</strong>`,
                margin: `<strong style="color: #228B22;">--</strong>`,
                ircc: `<strong style="color: #228B22;">--</strong>`,
                advancePayment: `<strong style="color: #228B22;">${formatNumber(totalAdvancePayments)}</strong>`,
                totalMonthlyPayment: `<strong style="color: #228B22;">${formatNumber(totalMonthlyRatesPayment)}</strong>`,
                insurance: `<strong style="color: #228B22;">${formatNumber(totalInsurancePayment)}</strong>`,
                totalPayment: `<strong style="color: #228B22;">${formatNumber(grandTotalMonth)}</strong>`,
                maturity: `<strong style="color: #228B22;">--</strong>`,
            });

            // const originalTotals = calculateTotalPaid(data.fixedRate, data.ircc + data.margin, data.months, data.credit, data.fixedRatePeriod, data.insurancePercent);
            const originalTotals = calculateTotalWithReducingRate(data.credit, data.months, data.fixedRate, data.ircc + data.margin, data.fixedRatePeriod, data.insurancePercent);
            originalTotalPaid = originalTotals.totalPaid;
            originalInsurancePaid = originalTotals.totalInsurancePaid;
            savedInRatesTotal = Math.round((originalTotalPaid - totalMonthlyRatesPayment) * 100) / 100;
            savedInsurance = Math.round((originalInsurancePaid - totalInsurancePayment) * 100) / 100;
            savedInTotal = savedInRatesTotal + savedInsurance;

            summaryRows.push({
                originalTotalPaid: originalTotalPaid,
                originalInsurancePaid: originalInsurancePaid,
                savedInRatesTotal: savedInRatesTotal,
                savedInsurance: savedInsurance,
                savedInTotal: savedInTotal,
            });

            return {
                rows,
                summaryRows,
            };
        }

        function calculateLoanWithLowerRate(data) {
            const rows = [];
            const summaryRows = [];
            let remainingBalance = data.credit;
            let totalInterest = 0;
            let totalPrincipal = 0;
            let totalMonthlyRates = 0;
            let totalAdvancePayments = 0;
            let totalMonthlyRatesPayment = 0;
            let totalInsurancePayment = 0;
            let grandTotalMonth = 0;
            let adjustedMonthlyAdvancePayment = data.monthlyAdvancePayment;

            const originalRateFixed = calculatePMT(
                data.fixedRate,
                data.months,
                data.credit,
            );
            let originalRateVariable;

            const remainingBalanceAfterFixed = calculateRemainingBalance(
                data.fixedRate,
                data.months,
                data.credit,
                data.fixedRatePeriod,
            );

            originalRateVariable = calculatePMT(
                data.ircc + data.margin,
                data.months - data.fixedRatePeriod,
                remainingBalanceAfterFixed,
            );

            for (let month = 1; month <= data.months; month++) {
                const rate =
                    month <= data.fixedRatePeriod ? data.fixedRate : data.ircc + data.margin;
                let remainingTerm = data.months - month + 1;
                const originalRate =
                    month <= data.fixedRatePeriod ? originalRateFixed : originalRateVariable;
                let newRate = calculatePMT(rate, remainingTerm, remainingBalance);

                let monthlyInterest = (remainingBalance * rate) / 12 / 100;
                let principal = newRate - monthlyInterest;
                let advancePayment = Math.max(0, data.monthlyAdvancePayment + (originalRate - newRate));

                if (month >= data.fixedRatePeriod + 1) {
                    advancePayment = Math.max(
                        0,
                        data.monthlyAdvancePayment + (originalRateFixed - newRate),
                    );
                }

                let totalMonthlyPayment = newRate + advancePayment;

                const insurance = (remainingBalance * data.insurancePercent) / 100;

                if (remainingBalance <= newRate + advancePayment) {
                    newRate = remainingBalance;
                    principal = newRate - monthlyInterest;
                    advancePayment = Math.max(0, newRate - principal);
                    totalMonthlyPayment = newRate + advancePayment;
                    remainingBalance = 0;
                    remainingTerm = 1;
                    totalInterest += monthlyInterest;
                    totalPrincipal += principal;
                    totalMonthlyRates += newRate;
                    totalAdvancePayments += advancePayment;
                    totalMonthlyRatesPayment += totalMonthlyPayment;
                    totalInsurancePayment += insurance;
                    grandTotalMonth += totalMonthlyPayment + insurance;
                } else {
                    remainingBalance = Math.max(
                        0,
                        remainingBalance - principal - advancePayment,
                    );
                    totalInterest += monthlyInterest;
                    totalPrincipal += principal;
                    totalMonthlyRates += newRate;
                    totalAdvancePayments += advancePayment;
                    totalMonthlyRatesPayment += totalMonthlyPayment;
                    totalInsurancePayment += insurance;
                    grandTotalMonth += totalMonthlyPayment + insurance;
                }

                rows.push({
                    month,
                    remainingBalance: remainingBalance,
                    monthlyPayment: newRate,
                    principal: principal,
                    interest: monthlyInterest,
                    rate: rate,
                    margin: month <= data.fixedRatePeriod ? 0 : data.margin,
                    ircc: month <= data.fixedRatePeriod ? 0 : data.ircc,
                    advancePayment: advancePayment,
                    totalMonthlyPayment: totalMonthlyPayment,
                    insurance: insurance,
                    totalPayment: totalMonthlyPayment + insurance,
                    maturity: remainingTerm - 1,
                });

                if (remainingBalance <= 0) {
                    break;
                }
            }

            rows.push({
                month: "TOTALURI",
                remainingBalance: `<strong style="color: #228B22;">--</strong>`,
                monthlyPayment: `<strong style="color: #228B22;">${formatNumber(totalMonthlyRates)}</strong>`,
                principal: `<strong style="color: #228B22;">${formatNumber(totalPrincipal)}</strong>`,
                interest: `<strong style="color: #228B22;">${formatNumber(totalInterest)}</strong>`,
                rate: `<strong style="color: #228B22;">--</strong>`,
                margin: `<strong style="color: #228B22;">--</strong>`,
                ircc: `<strong style="color: #228B22;">--</strong>`,
                advancePayment: `<strong style="color: #228B22;">${formatNumber(totalAdvancePayments)}</strong>`,
                totalMonthlyPayment: `<strong style="color: #228B22;">${formatNumber(totalMonthlyRatesPayment)}</strong>`,
                insurance: `<strong style="color: #228B22;">${formatNumber(totalInsurancePayment)}</strong>`,
                totalPayment: `<strong style="color: #228B22;">${formatNumber(grandTotalMonth)}</strong>`,
                maturity: `<strong style="color: #228B22;">--</strong>`,
            });

            const originalTotals = calculateTotalPaid(data.fixedRate, data.ircc + data.margin, data.months, data.credit, data.fixedRatePeriod, data.insurancePercent);
            originalTotalPaid = originalTotals.totalPaid;
            originalInsurancePaid = originalTotals.totalInsurancePaid;
            savedInRatesTotal = Math.round((originalTotalPaid - totalMonthlyRatesPayment) * 100) / 100;
            savedInsurance = Math.round((originalInsurancePaid - totalInsurancePayment) * 100) / 100;
            savedInTotal = savedInRatesTotal + savedInsurance;

            summaryRows.push({
                originalTotalPaid: originalTotalPaid,
                originalInsurancePaid: originalInsurancePaid,
                savedInRatesTotal: savedInRatesTotal,
                savedInsurance: savedInsurance,
                savedInTotal: savedInTotal,
            });

            return {
                rows,
                summaryRows,
            };
        }

        function calculateLoanWithLowerPeriod(data) {
            const rows = [];
            const summaryRows = [];
            let remainingBalance = data.credit;
            let initialRate = calculatePMT(data.fixedRate, data.months, data.credit);
            let totalInterest = 0;
            let totalPrincipal = 0;
            let totalMonthlyRates = 0;
            let totalAdvancePayments = 0;
            let totalMonthlyRatesPayment = 0;
            let totalInsurancePayment = 0;
            let grandTotalMonth = 0;
            let adjustedMonthlyAdvancePayment = data.monthlyAdvancePayment;
            let maxTotalMonthlyPayment = 0;

            for (let month = 1; month <= data.months; month++) {
                const rate =
                    month <= data.fixedRatePeriod ? data.fixedRate : data.ircc + data.margin;

                if (month === data.fixedRatePeriod + 1) {
                    const lastFixedRateRow = rows[data.fixedRatePeriod - 1];
                    const leftMaturity = lastFixedRateRow.maturity;
                    remainingBalance = lastFixedRateRow.remainingBalance;
                    initialRate = calculatePMT(rate, leftMaturity, remainingBalance);

                    maxTotalMonthlyPayment = lastFixedRateRow.totalMonthlyPayment;
                }

                if (month >= data.fixedRatePeriod + 1) {
                    adjustedMonthlyAdvancePayment = Math.max(
                        0,
                        maxTotalMonthlyPayment - initialRate,
                    );
                }

                let monthlyInterest = (remainingBalance * rate) / 12 / 100;
                let principal = initialRate - monthlyInterest;
                let advancePayment = Math.min(
                    adjustedMonthlyAdvancePayment,
                    remainingBalance - principal,
                );
                let leftMaturity = data.months - month;

                if (advancePayment > 0) {
                    leftMaturity = calculateRemainingTerm(
                        remainingBalance,
                        rate,
                        initialRate,
                        advancePayment,
                    );
                }

                let totalMonthlyPayment = initialRate + advancePayment;

                const insurance = (remainingBalance * data.insurancePercent) / 100;

                if (remainingBalance <= initialRate) {
                    initialRate = remainingBalance;
                    principal = initialRate - monthlyInterest;
                    advancePayment = initialRate - principal;
                    adjustedMonthlyAdvancePayment = initialRate - principal;
                    totalMonthlyPayment = initialRate + advancePayment;
                    remainingBalance = 0;
                    leftMaturity = 0;
                    totalMonthlyRates += initialRate;
                    totalPrincipal += principal;
                    totalInterest += monthlyInterest;
                    totalAdvancePayments += advancePayment;
                    totalMonthlyRatesPayment += totalMonthlyPayment;
                    totalInsurancePayment += insurance;
                    grandTotalMonth += totalMonthlyPayment + insurance;
                } else {
                    remainingBalance = Math.max(
                        0,
                        remainingBalance - principal - advancePayment,
                    );
                    totalMonthlyRates += initialRate;
                    totalPrincipal += principal;
                    totalInterest += monthlyInterest;
                    totalAdvancePayments += advancePayment;
                    totalMonthlyRatesPayment += totalMonthlyPayment;
                    totalInsurancePayment += insurance;
                    grandTotalMonth += totalMonthlyPayment + insurance;
                }

                rows.push({
                    month,
                    remainingBalance: remainingBalance,
                    monthlyPayment: initialRate,
                    principal,
                    interest: monthlyInterest,
                    rate,
                    margin: month <= data.fixedRatePeriod ? 0 : data.margin,
                    ircc: month <= data.fixedRatePeriod ? 0 : data.ircc,
                    advancePayment,
                    totalMonthlyPayment,
                    insurance,
                    totalPayment: totalMonthlyPayment + insurance,
                    maturity: leftMaturity,
                });

                if (remainingBalance <= 0) {
                    break;
                }
            }

            rows.push({
                month: "TOTALURI",
                remainingBalance: `<strong style="color: #228B22;">--</strong>`,
                monthlyPayment: `<strong style="color: #228B22;">${formatNumber(totalMonthlyRates)}</strong>`,
                principal: `<strong style="color: #228B22;">${formatNumber(totalPrincipal)}</strong>`,
                interest: `<strong style="color: #228B22;">${formatNumber(totalInterest)}</strong>`,
                rate: `<strong style="color: #228B22;">--</strong>`,
                margin: `<strong style="color: #228B22;">--</strong>`,
                ircc: `<strong style="color: #228B22;">--</strong>`,
                advancePayment: `<strong style="color: #228B22;">${formatNumber(totalAdvancePayments)}</strong>`,
                totalMonthlyPayment: `<strong style="color: #228B22;">${formatNumber(totalMonthlyRatesPayment)}</strong>`,
                insurance: `<strong style="color: #228B22;">${formatNumber(totalInsurancePayment)}</strong>`,
                totalPayment: `<strong style="color: #228B22;">${formatNumber(grandTotalMonth)}</strong>`,
                maturity: `<strong style="color: #228B22;">--</strong>`,
            });

            const originalTotals = calculateTotalPaid(data.fixedRate, data.ircc + data.margin, data.months, data.credit, data.fixedRatePeriod, data.insurancePercent);
            originalTotalPaid = originalTotals.totalPaid;
            originalInsurancePaid = originalTotals.totalInsurancePaid;
            savedInRatesTotal = Math.round((originalTotalPaid - totalMonthlyRatesPayment) * 100) / 100;
            savedInsurance = Math.round((originalInsurancePaid - totalInsurancePayment) * 100) / 100;
            savedInTotal = savedInRatesTotal + savedInsurance;

            summaryRows.push({
                originalTotalPaid: originalTotalPaid,
                originalInsurancePaid: originalInsurancePaid,
                savedInRatesTotal: savedInRatesTotal,
                savedInsurance: savedInsurance,
                savedInTotal: savedInTotal,
            });

            return {
                rows,
                summaryRows,
            };
        }

        function renderTable(data) {
            const table = document.getElementById("loanTable");
            const summaryTable = document.getElementById("summaryTable");
            summaryTable.innerHTML = "";
            table.innerHTML = "";

            const headers = [
                "Luna",
                "Rămas de plată",
                "Rata lunară de plată",
                "Principal",
                "Dobândă",
                "Rata dobânzii",
                "Marja fixă a băncii",
                "IRCC",
                "Rambursare anticipată",
                "Rata lunară",
                "Comision / asigurare lunară",
                "Total / Lună",
                "Maturitate",
            ];

            const summaryHeaders = [
                "Suma totală plătită inițial<br><span style='color: #f0f0f0; font-size: small; font-style: italic; font-weight: normal;'>*fără plăți anticipate</span>",
                "Asigurare /comision total plătit <br><span style='color: #f0f0f0; font-size: small; font-style: italic; font-weight: normal;'>*fără plăți anticipate</span>",
                "Economie din ratele inițiale<br><span style='color: #f0f0f0; font-size: small; font-style: italic; font-weight: normal;'>*cu plăți anticipate</span>",
                "Economie din asigurare / comision inițial<br><span style='color: #f0f0f0; font-size: small; font-style: italic; font-weight: normal;'>*cu plăți anticipate</span>",
                "Economie totală<br><span style='color: #f0f0f0; font-size: small; font-style: italic; font-weight: normal;'>*cu plăți anticipate</span>",
            ];

            let headerRow = table.insertRow();
            let summaryHeaderRow = summaryTable.insertRow();

            headers.forEach((header) => {
                let th = document.createElement("th");
                th.textContent = header;
                headerRow.appendChild(th);
            });

            summaryHeaders.forEach((header) => {
                let th = document.createElement("th");
                th.innerHTML = header;
                summaryHeaderRow.appendChild(th);
            });

            let rows = [];
            let summaryRows = [];
            if (data.calculationType === "scaderea_ratei") {
                result = calculateLoanWithLowerRate(data);
                rows = result.rows;
                summaryRows = result.summaryRows;
            } else if (data.calculationType === "scaderea_perioadei") {
                result = calculateLoanWithLowerPeriod(data);
                rows = result.rows;
                summaryRows = result.summaryRows;
            } else if (data.calculationType === "rate_descrescatoare") {
                result = calculateLoanWithReducingRate(data);
                rows = result.rows;
                summaryRows = result.summaryRows;
            }

            rows.forEach((row) => {
                let tr = table.insertRow();
                Object.entries(row).forEach(([key, value]) => {
                    let td = tr.insertCell();
                    if (key === "month") {
                        td.textContent = value.toString();
                    } else if (typeof value === "number") {
                        td.textContent = formatNumber(value);
                    } else {
                        td.innerHTML = value;
                    }
                });
            });

            summaryRows.forEach((row) => {
                let tr = summaryTable.insertRow();
                Object.entries(row).forEach(([key, value]) => {
                    let td = tr.insertCell();
                    if (typeof value === "number") {
                        td.textContent = formatNumber(value);
                    } else {
                        td.innerHTML = value;
                    }
                });
            });
        }

        function exportTableToCSV(data) {
            const table = document.getElementById("loanTable");
            const now = new Date();
            const currentTimestamp = now.toISOString().replace(/[:.]/g, '-').split('T')[0] + '_' + now.toTimeString().split(' ')[0].replace(/:/g, '-');
            let fileName = "loanoutput.csv";

            if (!table || table.rows.length <= 1) {
                console.error("Loan table is empty. Cannot export to CSV.");
                return;
            }

            let csv = [];
            const rows = table.querySelectorAll("tr");

            const headers = [];
            const headerCells = rows[0].querySelectorAll("th");
            headerCells.forEach((headerCell) => {
                headers.push(headerCell.textContent);
            });
            csv.push(headers.join(","));

            for (let i = 1; i < rows.length; i++) {
                const row = [];
                const cells = rows[i].querySelectorAll("td");
                cells.forEach((cell) => {
                    const cellText = cell.textContent.trim();
                    const numericValue = parseFloat(cellText.replace('.', '').replace(',', '.'));
                    if (!isNaN(numericValue)) {
                        row.push(numericValue);
                    } else {
                        row.push(cellText);
                    }
                });
                csv.push(row.join(","));
            }

            const csvString = csv.join("\n");
            const blob = new Blob([csvString], { type: "text/csv" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);

            if (data.calculationType === "scaderea_ratei") {
                fileName = "export_scadere_rata_" + currentTimestamp + ".csv";
            } else if (data.calculationType === "scaderea_perioadei") {
                fileName = "export_scadere_perioada_" + currentTimestamp + ".csv";
            } else if (data.calculationType === "rate_descrescatoare") {
                fileName = "export_rate_descrescatoare_" + currentTimestamp + ".csv";
            }

            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        document.getElementById("exportButton").addEventListener("click", function () {
            const formData = new FormData(document.getElementById("loanForm"));
            const loanData = Object.fromEntries(formData.entries());

            exportTableToCSV(loanData);
        });

        document
            .getElementById("calculateButton")
            .addEventListener("click", function () {
                const formData = new FormData(document.getElementById("loanForm"));
                const loanData = Object.fromEntries(formData.entries());

                for (let key in loanData) {
                    loanData[key] = Number(loanData[key]);
                }

                loanData.calculationType = document.getElementById("calculationType").value;

                renderTable(loanData);
            });

    </script>
    <noscript>
        <p><img alt="Dobanzi" width="1" height="1" src="//in.getclicky.com/101443145ns.gif" /></p>
    </noscript>
</body>

</html>
